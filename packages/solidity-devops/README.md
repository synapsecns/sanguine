# Solidity Development Operations

This package provides a set of tools and scripts to help with the development of Solidity smart contracts:

- Utilities to simplify the testing of smart contracts using Foundry.
- Utilities to simplify the deployment of smart contracts using Foundry.
- Utilities to manage the existing deployments of smart contracts.

## Disclaimer

This package is still under development and should be used with caution. It is not recommended to use it in a production environment.

## Docs

Forge docs are automatically deployed [here](https://solidity-devops.vercel.app).

## Setup

In order to use this package, it needs to be installed as a dependency in your project. It is recommended to install it as a dev dependency.

```bash
npm install --save-dev @synapsecns/solidity-devops
# Or, if you are using yarn
yarn add --dev @synapsecns/solidity-devops
```

Following files are necessary to be present in the root of your project:

- `.env`: storage for the sensitive configuration variables.
- `devops.json`: configuration file for the devops package.
- `foundry.toml`: configuration file for Foundry.

### `.env`

**Note: This file must be added to `.gitignore` to avoid sharing sensitive information.**

See the [example .env](./.env.example) file. Following structure is required:

- `Wallets`: defines the deployer wallets used for running the scripts. Assuming the `chad` is the name of the wallet, the following values are required:
  - `CHAD_ADDRESS`: the address of the account to use for signing
  - `CHAD_TYPE`: the type of the wallet:
    - `keystore`: use the encrypted keystore file.
      - `CHAD_JSON`: the keystore file path
    - `ledger` or `trezor`: use the hardware wallet.
      - TODO: find out if ledger/trezor specific options are needed
    - `pk`: use the plaintext private key. STRONGLY DISCOURAGED for production usage, meant for local devnet purposes.
      - `CHAD_PK`: the private key to the wallet in 0x format.
    - Any other value triggers the interactive prompt to enter the private key.
- `Chains`: defines the list of chains where the scripts will run. Assuming the `chain` is the name of the chain, the following values are required:
  - `CHAIN_RPC`: the RPC endpoint of the chain
  - `CHAIN_VERIFIER`: verifier for the smart contracts. Possible values:
    - `etherscan`
    - `blockscout`
    - `sourcify`
  - `CHAIN_VERIFIER_URL`: the Verifier API endpoint (required if verifier is not sourcify)
    - **Note: Blockscout URL needs to end with "/api?" for the verification to work.**
  - `CHAIN_VERIFIER_KEY`: the Verifier API key (required if verifier is not sourcify)
    - **Note: Use any non-empty string for Blockscout API key: it is not required per se, but foundry will complain if it's empty.**

### `devops.json`

See the [example devops.json](./devops.json) file. Following values are required:

- `chains`: list of chain-specific options for `forge script` command.
  - Check the available options by running `forge script --help`.
  - Two additional options to handle the gas pricing are introduced:
    - `--auto-gas-1559`: will fetch the current base fee and priority fee from the chain's RPC node, and use following values for submitting the transactions:
      - `maxPriorityFee = priorityFee`
      - `maxGasPrice = 2 * baseFee + priorityFee`
    - `--auto-gas-legacy`: will fetch the current gas price from the chain's RPC node, and use it for submitting the transactions.
      > Note: these options are introduced as foundry script hardcodes the 3 Gwei priority fee, which is not ideal for all the chains.
- `deployConfigs`: path to the directory that contains the deployment configuration files. These configuration files are expected to be either chain-specific or global:
  - The chain-specific configuration files should be located in `deployConfigsDir/{chainName}/{contractName}.dc.json`.
  - The global configuration files should be located in `deployConfigsDir/global/{contractName}.{globalProperty}.json` or `deployConfigsDir/global/{contractName}.json`.
  - The configuration files usually include the variables required for the contract deployment or its subsequent management.
- `deployments`: path to the directory that contains the deployment artifact files. These files are automatically generated by `fsr` and alike commands.
- `forgeArtifacts`: path to the directory that `forge` uses to store the artifacts for the compiled contracts.
  - **Must match the `out` value in the `foundry.toml` file.**
- `freshDeployments`: path to the directory that contains the **fresh** deployment artifact files. These files are generated during the local run of the `forge script` command.
  - It is recommended to add this directory to `.gitignore` to avoid unnecessary changes in the repository.
  - The artifacts in this directory are automatically moved into the `deployments` directory by `fsr` and alike commands.
    > Note: we opted to use this approach, as the local run of the `forge script` is always done before the actual broadcast of the deployment transactions. Therefore, the end results might not match the local run, if there was an unexpected on-chain revert, or if transactions were not included in the block. A separate job is automatically run to check all the new artifacts and move them to the `deployments` directory, if the on-chain deployment was successful.

### `foundry.toml`

See the [example foundry.toml](./foundry.toml) file. Following values are required:

- `fs_permissions`:
  - `{ access = "read", path = "./" }` to allow reading files from the repository root
  - `{ access = "read-write", path = "<freshDeployments>" }` to allow reading/writing fresh deployment artifacts
- `rpc_endpoints`:
  - It is recommended to follow the structure defined in the example file to avoid duplication:
    - `arbitrum = "${ARBITRUM_RPC}"`
- `etherscan`:
  - It is recommended to follow the structure defined in the example file to avoid duplication:
    - `arbitrum = { key = "${ARBITRUM_VERIFIER_KEY}", url = "${ARBITRUM_VERIFIER_URL}" }`
    - You should omit values for chains that are using Sourcify for verification.

See the [Foundry Book](https://book.getfoundry.sh/config/) for more information.
